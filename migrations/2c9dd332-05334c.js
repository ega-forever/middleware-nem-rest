
module.exports.id = '2c9dd332.05334c';

const _ = require('lodash'),
  config = require('../config');

/**
 * @description flow 2c9dd332.05334c update
 * @param done
 */
   

module.exports.up = function (done) {
  let coll = this.db.collection(`${_.get(config, 'nodered.mongo.collectionPrefix', '')}noderedstorages`);
  coll.update({"path":"2c9dd332.05334c","type":"flows"}, {
    $set: {"path":"2c9dd332.05334c","body":[{"id":"5a35929d.0a716c","type":"http in","z":"2c9dd332.05334c","name":"create addr","url":"/addr","method":"post","upload":false,"swaggerDoc":"","x":110,"y":40,"wires":[["5534fe83.7a497"]]},{"id":"27b27b8e.9827a4","type":"mongo","z":"2c9dd332.05334c","model":"EthAccount","request":"{}","options":"","name":"mongo create addr","mode":"1","requestType":"1","dbAlias":"primary.accounts","x":770,"y":200,"wires":[["344c4f71.cda97"]]},{"id":"7c68e0a0.c140d","type":"mongo","z":"2c9dd332.05334c","model":"EthAccount","request":"{}","options":"","name":"mongo","mode":"1","requestType":"2","dbAlias":"primary.accounts","x":730,"y":540,"wires":[["dd1d132c.4a4f7"]]},{"id":"316484c0.63001c","type":"function","z":"2c9dd332.05334c","name":"params","func":"const prefix = global.get('settings.mongo.accountPrefix');\n\nmsg.address = msg.payload.address;\nmsg.payload = {\n    model: `${prefix}Account`, \n    request: [{\n       address: msg.payload.address\n   }, {isActive: false}]\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":540,"wires":[["7c68e0a0.c140d"]]},{"id":"468de3dc.eb162c","type":"http in","z":"2c9dd332.05334c","name":"balance","url":"/addr/:addr/balance","method":"get","upload":false,"swaggerDoc":"","x":70,"y":720,"wires":[["1854b464.38d28c"]]},{"id":"6731d0f7.68fb4","type":"function","z":"2c9dd332.05334c","name":"transform params","func":"const prefix = global.get('settings.mongo.accountPrefix');\n\nmsg.payload = {\n    model: `${prefix}Account`,  \n    request: {\n       address: msg.req.params.addr\n   }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":720,"wires":[["a66b89d5.08b868"]]},{"id":"a66b89d5.08b868","type":"mongo","z":"2c9dd332.05334c","model":"EthAccount","request":"{}","options":"","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.accounts","x":590,"y":720,"wires":[["97ae203e.df01a"]]},{"id":"6e227f25.b210e","type":"http response","z":"2c9dd332.05334c","name":"","statusCode":"","x":911.250007629395,"y":719.99999904632,"wires":[]},{"id":"e859d127.685df","type":"catch","z":"2c9dd332.05334c","name":"","scope":["84e2ac9a.6bab9","1dbd7f6c.ccca81","468de3dc.eb162c","4ae0a952.a4e188","c46dd171.28a02","5a35929d.0a716c","7ac5982a.2d2c68","933bde12.57d0a","47043366.c3b4fc","32e96375.e31dbc","921b5d7c.258d8","97ae203e.df01a","1097d605.d7a2ea","dd1d132c.4a4f7","344c4f71.cda97","5534fe83.7a497","74f8b9a2.d6f7b8","e69266cd.e2b688","6e227f25.b210e","2d0c2014.909c4","e9be6f8.737d29","1854b464.38d28c","da7ed8ee.8a20d8","aed87f82.33dd9","6ccd77f0.9bca48","a66b89d5.08b868","7c68e0a0.c140d","4b0ebfc3.c5f5f","547d0ad7.ffb894","b1950336.2e42f","1e8db842.2aded8","316484c0.63001c","f8fd8fe7.b361c","cea9fdeb.9c011","aa73f075.59b5f","27c64d64.24efd2","3d20f750.413ac8","25d921b8.67808e","6731d0f7.68fb4","287bc20e.b9bb2e","4891676a.f38f98"],"x":200,"y":940,"wires":[["547d0ad7.ffb894","3d20f750.413ac8"]]},{"id":"547d0ad7.ffb894","type":"debug","z":"2c9dd332.05334c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":307.076400756836,"y":866.347267150879,"wires":[]},{"id":"4ae0a952.a4e188","type":"async-function","z":"2c9dd332.05334c","name":"calc balance","func":"const prefix = global.get('settings.mongo.accountPrefix');\n\nmsg.address = msg.payload\n    .address.replace(/[^\\w\\s]/gi, '');\n\n\nmsg.payload = {\n    model: `${prefix}Account`, \n    request: {\n       address: msg.address,\n       isActive: true\n   }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":200,"wires":[["27b27b8e.9827a4"]]},{"id":"cea9fdeb.9c011","type":"amqp in","z":"2c9dd332.05334c","name":"post addresses","topic":"${config.rabbit.serviceName}.account.create","configname":"","iotype":"3","ioname":"events","noack":"0","durablequeue":"1","durableexchange":"0","server":"","servermode":"1","x":100,"y":260,"wires":[["921b5d7c.258d8"]]},{"id":"921b5d7c.258d8","type":"function","z":"2c9dd332.05334c","name":"","func":"\nmsg.payload = JSON.parse(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":260,"wires":[["4ae0a952.a4e188"]]},{"id":"c46dd171.28a02","type":"catch","z":"2c9dd332.05334c","name":"","scope":["27b27b8e.9827a4"],"x":590,"y":140,"wires":[["25d921b8.67808e"]]},{"id":"25d921b8.67808e","type":"function","z":"2c9dd332.05334c","name":"transform","func":"const prefix = global.get('settings.mongo.accountPrefix');\n \nlet factories = global.get(\"factories\"); \nlet error = msg.error.message;\ntry {\n    error = JSON.parse(error);\n    if(error.code !== 11000)\n        throw new Error();\n} catch(e){\n    throw new Error(error);\n}\n\n\n\nmsg.payload = {\n    model: `${prefix}Account`, \n    request: [\n        {address: msg.payload.request.address}, \n        {$set:{ isActive: true}}\n        ]\n   \n};\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":140,"wires":[["6ccd77f0.9bca48"]]},{"id":"6ccd77f0.9bca48","type":"mongo","z":"2c9dd332.05334c","model":"EthAccount","request":"{}","options":"","name":"mongo","mode":"1","requestType":"2","dbAlias":"primary.accounts","x":890,"y":140,"wires":[["344c4f71.cda97"]]},{"id":"344c4f71.cda97","type":"function","z":"2c9dd332.05334c","name":"","func":"\nif(msg.amqpMessage)\n    msg.amqpMessage.ackMsg();\n\nmsg.payload = JSON.stringify({address: msg.address})\n\nreturn msg;","outputs":1,"noerr":0,"x":970,"y":200,"wires":[["32e96375.e31dbc","e9be6f8.737d29"]]},{"id":"32e96375.e31dbc","type":"amqp out","z":"2c9dd332.05334c","name":"","topic":"${config.rabbit.serviceName}.account.created","iotype":"3","ioname":"events","server":"","servermode":"1","x":1150,"y":180,"wires":[]},{"id":"287bc20e.b9bb2e","type":"amqp in","z":"2c9dd332.05334c","name":"update balance addresses","topic":"${config.rabbit.serviceName}.account.balance","iotype":"3","ioname":"events","noack":"0","durablequeue":"1","durableexchange":"0","server":"","servermode":"1","x":130,"y":380,"wires":[["4891676a.f38f98"]]},{"id":"4891676a.f38f98","type":"async-function","z":"2c9dd332.05334c","name":"update calc balance","func":"msg.payload = JSON.parse(msg.payload);\nmsg.address = msg.payload.address.replace(/[^\\w\\s]/gi, '');\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":380,"wires":[["1097d605.d7a2ea"]]},{"id":"e69266cd.e2b688","type":"http response","z":"2c9dd332.05334c","name":"","statusCode":"","x":790,"y":920,"wires":[]},{"id":"3d20f750.413ac8","type":"function","z":"2c9dd332.05334c","name":"transform","func":"\nlet factories = global.get(\"factories\"); \nlet error = msg.error.message;\ntry {\n    error = JSON.parse(error);\n}catch(e){}\n\nmsg.payload = error && error.code === 11000 ? \nfactories.messages.address.existAddress :\nfactories.messages.generic.fail;\n\n\nif (msg.statusCode == '401' || msg.statusCode == '400')\n    msg.payload = factories.messages.generic.failAuth;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":940,"wires":[["27c64d64.24efd2"]]},{"id":"27c64d64.24efd2","type":"switch","z":"2c9dd332.05334c","name":"","property":"amqpMessage","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","outputs":2,"x":570,"y":940,"wires":[["e69266cd.e2b688","b1950336.2e42f"],["1dbd7f6c.ccca81","4b0ebfc3.c5f5f"]]},{"id":"1dbd7f6c.ccca81","type":"async-function","z":"2c9dd332.05334c","name":"","func":"if(msg.error.message.includes('CONNECTION_ERROR')){\n    await Promise.delay(5000);\n    await msg.amqpMessage.nackMsg();\n}else{\n    await msg.amqpMessage.ackMsg();\n}\n    \nmsg.payload = typeof msg.error.message;    \n    \nreturn msg;","outputs":1,"noerr":6,"x":790,"y":980,"wires":[[]]},{"id":"4b0ebfc3.c5f5f","type":"debug","z":"2c9dd332.05334c","name":"","active":true,"console":"false","complete":"error","x":799.0729522705078,"y":1025.895881652832,"wires":[]},{"id":"b1950336.2e42f","type":"debug","z":"2c9dd332.05334c","name":"","active":true,"console":"false","complete":"false","x":740,"y":839,"wires":[]},{"id":"aa73f075.59b5f","type":"amqp in","z":"2c9dd332.05334c","name":"remove addr","topic":"${config.rabbit.serviceName}.account.delete","configname":"","iotype":"3","ioname":"events","noack":"0","durablequeue":"1","durableexchange":"0","server":"","servermode":"1","x":88.19097137451172,"y":616.3229627609253,"wires":[["f8fd8fe7.b361c"]]},{"id":"f8fd8fe7.b361c","type":"function","z":"2c9dd332.05334c","name":"parse","func":"\nmsg.payload = JSON.parse(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":620,"wires":[["316484c0.63001c"]]},{"id":"dd1d132c.4a4f7","type":"function","z":"2c9dd332.05334c","name":"","func":"\nif(msg.amqpMessage)\n    msg.amqpMessage.ackMsg();\n\nmsg.payload = JSON.stringify({address: msg.address})\n\nreturn msg;","outputs":1,"noerr":0,"x":910,"y":540,"wires":[["47043366.c3b4fc"]]},{"id":"47043366.c3b4fc","type":"amqp out","z":"2c9dd332.05334c","name":"","topic":"${config.rabbit.serviceName}.account.deleted","iotype":"3","ioname":"events","server":"","servermode":"1","x":1210,"y":540,"wires":[]},{"id":"2d0c2014.909c4","type":"amqp out","z":"2c9dd332.05334c","name":"","topic":"${config.rabbit.serviceName}_user.created","iotype":"3","ioname":"internal","server":"","servermode":"1","x":920,"y":380,"wires":[]},{"id":"1097d605.d7a2ea","type":"function","z":"2c9dd332.05334c","name":"","func":"\nif(msg.amqpMessage)\n    msg.amqpMessage.ackMsg();\n\nmsg.payload = JSON.stringify({address: msg.address})\n\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":380,"wires":[["2d0c2014.909c4"]]},{"id":"97ae203e.df01a","type":"function","z":"2c9dd332.05334c","name":"","func":"const _ = global.get('_');\n \nlet account = msg.payload[0];\nlet confirmedBalance = _.get(account, 'balance.confirmed', 0);\nlet unconfirmedBalance = _.get(account, 'balance.unconfirmed', 0);\nlet vestedBalance = _.get(account, 'balance.vested', 0);\n\n\n\nlet balance = {\n    confirmed: {\n      value: confirmedBalance,\n      amount: `${(confirmedBalance/1000000).toFixed(6)}`\n    },\n    unconfirmed: {\n      value: unconfirmedBalance,\n      amount: `${(unconfirmedBalance/1000000).toFixed(6)}`\n    },\n    vested: {\n      value: vestedBalance,\n      amount: `${(vestedBalance/1000000).toFixed(6)}`\n    }\n}\n\nlet mosaics = _.chain(account.mosaics)\n    .toPairs()\n    .map(pair => {\n      let name = pair[0];\n      let data = pair[1];\n\n      data = {\n        confirmed: {\n          amount: data.confirmed / Math.pow(10, data.decimals),\n          value: data.confirmed\n        },\n        unconfirmed: {\n          amount: data.unconfirmed / Math.pow(10, data.decimals),\n          value: data.unconfirmed\n        },\n        decimals: data.decimals\n      };\n\n      return [name, data];\n    })\n    .fromPairs()\n    .value();\n\nmsg.payload = {balance, mosaics};\n\nreturn msg;\n","outputs":1,"noerr":0,"x":730,"y":720,"wires":[["6e227f25.b210e"]]},{"id":"1854b464.38d28c","type":"laborx_auth","z":"2c9dd332.05334c","name":"laborx_auth","configprovider":"1","dbAlias":"accounts","providerpath":"http://localhost:3001","x":210,"y":720,"wires":[["6731d0f7.68fb4"]]},{"id":"5534fe83.7a497","type":"function","z":"2c9dd332.05334c","name":"","func":"\nmsg.payload = JSON.stringify(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":40,"wires":[["74f8b9a2.d6f7b8","84e2ac9a.6bab9"]]},{"id":"74f8b9a2.d6f7b8","type":"http response","z":"2c9dd332.05334c","name":"","statusCode":"","headers":{},"x":410,"y":20,"wires":[]},{"id":"84e2ac9a.6bab9","type":"amqp out","z":"2c9dd332.05334c","name":"address_created","topic":"${config.rabbit.serviceName}.account.create","configname":"","iotype":"3","ioname":"events","server":"","servermode":"1","x":450,"y":80,"wires":[]},{"id":"7ac5982a.2d2c68","type":"amqp in","z":"2c9dd332.05334c","name":"create_from_laborx","topic":"address.created","configname":"laborx","iotype":"1","ioname":"profiles","noack":"0","durablequeue":"1","durableexchange":"1","server":"","servermode":"1","x":110,"y":160,"wires":[["aed87f82.33dd9"]]},{"id":"aed87f82.33dd9","type":"laborx_get_addr","z":"2c9dd332.05334c","addr":"nem-address","name":"laborx_get_addr","x":320,"y":160,"wires":[["4ae0a952.a4e188"]]},{"id":"e9be6f8.737d29","type":"amqp out","z":"2c9dd332.05334c","name":"","topic":"${config.rabbit.serviceName}_user.created","configname":"","iotype":"3","ioname":"internal","server":"","servermode":"1","x":1160,"y":240,"wires":[]},{"id":"933bde12.57d0a","type":"amqp in","z":"2c9dd332.05334c","name":"delete_from_laborx","topic":"address.deleted","configname":"laborx","iotype":"1","ioname":"profiles","noack":"0","durablequeue":"1","durableexchange":"1","server":"","servermode":"1","x":110,"y":500,"wires":[["da7ed8ee.8a20d8"]]},{"id":"da7ed8ee.8a20d8","type":"laborx_get_addr","z":"2c9dd332.05334c","addr":"nem-address","name":"laborx_get_addr","x":320,"y":500,"wires":[["316484c0.63001c"]]}]}
  }, {upsert: true}, done);
};

module.exports.down = function (done) {
  let coll = this.db.collection(`${_.get(config, 'nodered.mongo.collectionPrefix', '')}noderedstorages`);
  coll.remove({"path":"2c9dd332.05334c","type":"flows"}, done);
};
